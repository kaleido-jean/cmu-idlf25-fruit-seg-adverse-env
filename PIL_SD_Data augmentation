
!pip install -q roboflow diffusers transformers accelerate safetensors pillow matplotlib numpy

# --- import package ---
from roboflow import Roboflow
import os, torch, random
import numpy as np
import matplotlib.pyplot as plt
from PIL import Image, ImageEnhance, ImageFilter, ImageDraw
from diffusers import StableDiffusionImg2ImgPipeline

# --- download dataset ---
rf = Roboflow(api_key="7TI8mHPqsyInAEUtwLsa")
project = rf.workspace("en-zbzva").project("all-pepper-datasets-q5opc")
version = project.version(1)
dataset = version.download("yolov9")

dataset_dir = dataset.location
train_images_dir = os.path.join(dataset_dir, "train", "images")

# --- choose specific image ---
target_prefixes = [
    "frame_0405_png",
    "frame_1830_png",
    "frame_0670_png",
    "frame_1920_png",
    "frame_3020_png"
]

def find_real_image(prefix, directory):
    for f in os.listdir(directory):
        if f.startswith(prefix):
            return f
    return None

sample_images = [find_real_image(p, train_images_dir) for p in target_prefixes]
sample_images = [f for f in sample_images if f is not None]
cols = len(sample_images)
print(" Using images:", sample_images)

# --- load Stable Diffusion ---
pipe = StableDiffusionImg2ImgPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5",
    torch_dtype=torch.float16
).to("cuda")

# --- adjust lightness (PIL层) ---
def apply_lighting(img, mode):
    if mode == "Strong Light":
        img = ImageEnhance.Brightness(img).enhance(1.3)
        img = ImageEnhance.Contrast(img).enhance(1.2)
        img = ImageEnhance.Color(img).enhance(1.1)
    elif mode == "Weak Light":
        img = ImageEnhance.Brightness(img).enhance(0.65)
        img = ImageEnhance.Contrast(img).enhance(0.8)
        img = ImageEnhance.Color(img).enhance(0.85)
    elif mode == "Rainy":
        img = ImageEnhance.Brightness(img).enhance(0.85)
        img = ImageEnhance.Contrast(img).enhance(0.9)
        img = ImageEnhance.Color(img).enhance(0.9)
    elif mode == "Foggy":
        img = ImageEnhance.Brightness(img).enhance(0.95)
        img = ImageEnhance.Contrast(img).enhance(0.8)
        img = ImageEnhance.Color(img).enhance(0.9)
    return img

# --- add rain overlay ---
def add_rain_overlay(img, density=300, blur=2):
    overlay = Image.new("RGBA", img.size, (0,0,0,0))
    draw = ImageDraw.Draw(overlay)
    w, h = img.size
    for _ in range(density):
        x = random.randint(0, w)
        y = random.randint(0, h)
        length = random.randint(10, 25)
        draw.line((x, y, x+1, y+length), fill=(200, 200, 255, random.randint(80, 120)), width=1)
    overlay = overlay.filter(ImageFilter.GaussianBlur(blur))
    combined = Image.alpha_composite(img.convert("RGBA"), overlay)
    return combined.convert("RGB")

# --- add fog overlay ---
def add_fog_overlay(img, intensity=0.4):
    w, h = img.size
    fog = Image.new("RGBA", img.size, (255, 255, 255, 0))
    fog_pixels = fog.load()
    for i in range(w):
        for j in range(h):
            alpha = int(255 * intensity * np.exp(-((j/h) * 2)))  # 上薄下浓
            fog_pixels[i, j] = (255, 255, 255, alpha)
    fog = fog.filter(ImageFilter.GaussianBlur(8))
    combined = Image.alpha_composite(img.convert("RGBA"), fog)
    return combined.convert("RGB")

# --- Stable Diffusion prompt ---
prompt_dict = {
    "Strong Light": "same peppers photo under strong noon sunlight, vivid green color, bright reflections, outdoor farm, clear sky",
    "Weak Light": "same peppers photo under cloudy soft light, overcast sky, gentle illumination, cool color tone, outdoor field",
    "Rainy": "same peppers photo during rain, visible raindrops on surface, wet reflective leaves, gray overcast background",
    "Foggy": "same peppers photo in thick fog, low contrast, soft diffused light, muted tones, foggy farm background"
}

strength_dict = {"Strong Light": 0.4, "Weak Light": 0.35, "Rainy": 0.43, "Foggy": 0.45}

# --- Main workflow ---
conditions = ["Original", "Strong Light", "Weak Light", "Rainy", "Foggy"]
output_dir = "/content/pepper_SD_combined_rainfog"
os.makedirs(output_dir, exist_ok=True)
generated = {cond: [] for cond in conditions}

for fname in sample_images:
    img_path = os.path.join(train_images_dir, fname)
    base = Image.open(img_path).convert("RGB").resize((512, 512))
    generated["Original"].append(base)

    for cond in conditions[1:]:
        pil_img = apply_lighting(base, cond)
        prompt = prompt_dict[cond]
        strength = strength_dict[cond]

        with torch.autocast("cuda"):
            result = pipe(
                prompt=prompt,
                image=pil_img,
                strength=strength,
                guidance_scale=9.0,
                num_inference_steps=40
            )
        gen = result.images[0]

        # add rain/fog overlay
        if cond == "Rainy":
            gen = add_rain_overlay(gen, density=400, blur=2)
        elif cond == "Foggy":
            gen = add_fog_overlay(gen, intensity=0.45)

        generated[cond].append(gen)
        gen.save(os.path.join(output_dir, f"{cond}_{fname}.png"))

print(f"All images generated and saved under: {output_dir}")

# --- visualization comparison ---
rows = len(conditions)
fig, axes = plt.subplots(
    rows, cols + 1,
    figsize=((cols + 1) * 2.2, rows * 2.4),
    gridspec_kw={'width_ratios': [0.6] + [1] * cols}
)

fig.suptitle("Original vs Generated Pepper Images", fontsize=16, x=0.52, y=0.96)

for i, cond in enumerate(conditions):
    ax_label = axes[i, 0]
    ax_label.text(0.95, 0.5, cond, ha='right', va='center', fontsize=12, fontweight='bold')
    ax_label.axis("off")
    for j in range(cols):
        axes[i, j + 1].imshow(generated[cond][j])
        axes[i, j + 1].axis("off")

plt.subplots_adjust(top=0.92, left=0.08, right=0.97, wspace=0.06, hspace=0.06)
plt.show()
